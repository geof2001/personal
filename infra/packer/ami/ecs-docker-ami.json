{
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "us-east-1",
      "profile": "SrDEV",
      "source_ami": "ami-0e297018",
      "instance_type": "t2.small",
      "ami_name": "ecs-kickstarter-{{timestamp}}",
      "ssh_username": "ec2-user",
      "vpc_id": "vpc-2856994f",
      "subnet_id": "subnet-ecec9dc6",
      "ami_regions": [
        "us-west-2"
      ],
      "ami_users": [
        "638782101961",
        "181133766305",
        "610352865374",
        "886239521314"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "server-scripts/install-datadog.sh",
      "destination": "/usr/local/bin/install-datadog.sh"
    },
    {
      "type": "file",
      "source": "server-scripts/update_ssh_authorized_keys.sh",
      "destination": "/usr/local/bin/update_ssh_authorized_keys.sh"
    },
    {
      "type": "file",
      "source": "server-scripts/initialize_ecs_at_start.sh",
      "destination": "/usr/local/bin/initialize_ecs_at_startup.sh"
    },
    {
      "type": "file",
      "source": "server-scripts/initialize_ecs_at_start.sh",
      "destination": "/usr/local/bin/initialize_ecs_at_startup.sh"
    },
    {
      "type": "file",
      "source": "server-scripts/initialize_ecs_at_start.sh",
      "destination": "/usr/local/bin/initialize_ecs_at_startup.sh"
    },
    {
      "type": "shell",
      "inline": [
        "set -x"

        "echo ECS_CLUSTER=${ServiceECSCluster} >> /etc/ecs/ecs.config",
        "export CLOUD_APP=ecs",
        "#export EFS_ID=${efsid}",
        "#export AWS_REGION=${regionid}",
        "yum update --exclude=ecs-init --exclude=docker --exclude=docker-devel --exclude=docker-pkg-devel -y",
        "yum install -y aws-cli openssl-devel nfs-utils",
        "#export ECS_BOOT_VERSION=${boot}",
        "#export SERVICE_DISCOVERY_TABLE=${ServiceDiscoveryTable}",
        "#export SERVICE_DISCOVERY_COUNTER_TABLE=${ServiceDiscoveryChangeCountersTable}",
        "echo '* hard nofile 100000' | tee -a /etc/security/limits.conf",
        "echo '* soft nofile 100000' | tee -a /etc/security/limits.conf",
        "ulimit -n 100000",
        "aws s3 cp --quiet --recursive s3://roku-ecs-boot/$ECS_BOOT_VERSION/  /usr/local/bin/",
        "chmod u+rx /usr/local/bin/*.sh /usr/local/bin/*.py",

        "sudo cp /tmp/update_ssh_authorized_keys.sh /usr/local/bin/update_ssh_authorized_keys.sh",
        "/usr/local/bin/initialize_ecs_at_startup.sh 2>&1 >> /tmp/initialize_ecs_at_startup.log",

        "sudo cp /tmp/update_ssh_authorized_keys.sh /usr/local/bin/update_ssh_authorized_keys.sh",
        "sudo chmod u+rx /tmp/*.sh /usr/local/bin/*.sh",
        "sudo /tmp/install-datadog.sh",
        "CRONTMP=\"/tmp/tmp.cron.$$\"",
        "cat > $CRONTMP <<EOL",
        "*/10 * * * * /usr/local/bin/update_ssh_authorized_keys.sh",
        "EOL"
      ]
    }
  ]
}
